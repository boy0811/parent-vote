{% extends "layout.html" %}
{% block title %}{{ vote_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="text-center mb-3">
    <h2>{{ vote_title }}</h2>
    <div class="mt-2">
      ğŸ“Œ ç•¶å‰éšæ®µï¼š<strong>{{ current_phase.name if current_phase else "å°šæœªé–‹å§‹" }}</strong>
    </div>
    {% if is_closed %}
      <div class="alert alert-warning mt-2">âš ï¸ æ­¤éšæ®µæŠ•ç¥¨å·²çµæŸï¼Œä»¥ä¸‹ç‚ºæœ€çµ‚ç¥¨æ•¸ã€‚</div>
    {% else %}
      <div class="text-muted">
        ç¥¨æ•¸æ¯ {{ refresh_interval }} ç§’æ›´æ–°ï¼Œå¹´ç´šè¼ªæ’­æ¯ {{ slide_interval }} ç§’åˆ‡æ›
      </div>
    {% endif %}
  </div>

  <!-- å¹´ç´šé¸å–® -->
  <div class="text-center mb-3" id="gradeMenu">
    <button class="btn btn-outline-primary m-1 grade-tab active" data-grade="å…¨éƒ¨">å…¨éƒ¨</button>
    {% for grade in grouped_candidates_serializable.keys() %}
      {% if grade != 'å…¨éƒ¨' %}
        <button class="btn btn-outline-primary m-1 grade-tab" data-grade="{{ grade }}">{{ grade }}</button>
      {% endif %}
    {% endfor %}
  </div>

  <div class="text-center mb-3">
    <strong>ç›®å‰å¹´ç´šï¼š</strong><span id="currentGrade">å…¨éƒ¨</span>
  </div>

  <!-- æ“ä½œå€ -->
  {% if not is_closed %}
  <div class="text-center mb-4 d-print-none" id="controlPanel">
    <button class="btn btn-secondary me-2" onclick="toggleFullscreen()">ğŸ–¥ï¸ å…¨è¢å¹•</button>
    <button class="btn btn-primary" id="toggleSlideBtn" onclick="toggleSlide()">â¸ï¸ æš«åœè¼ªæ’­</button>
    <button class="btn btn-danger me-2" onclick="closeVote()">ğŸ”´ é—œé–‰æŠ•ç¥¨</button>
    <a href="/admin/winners" class="btn btn-success me-2">ğŸ“Š å‰å¾€çœ‹çµæœ</a>
  </div>
  {% endif %}

  <!-- å€™é¸äººå¡ç‰‡å€ -->
  <div id="gradeSections">
    {% set all_key_exists = 'å…¨éƒ¨' in grouped_candidates_serializable %}
    {% if not all_key_exists %}
      <div class="grade-section" data-grade="å…¨éƒ¨" style="display: block;">
        <div class="row" id="cardContainer-å…¨éƒ¨"></div>
        <div class="text-center mt-3">
          <!-- âœ… æŠŠ grade å‚³é€² JS -->
          <button class="btn btn-outline-secondary me-2" data-role="prev" data-grade="å…¨éƒ¨" onclick="prevPageAcrossGrades('å…¨éƒ¨')">â¬…ï¸ ä¸Šä¸€é </button>
          <span id="pageInfo-å…¨éƒ¨"></span>
          <button class="btn btn-outline-secondary ms-2" data-role="next" data-grade="å…¨éƒ¨" onclick="nextPageAcrossGrades('å…¨éƒ¨')">â¡ï¸ ä¸‹ä¸€é </button>
        </div>
      </div>
    {% endif %}

    {% for grade, candidates in grouped_candidates_serializable.items() %}
      <div class="grade-section" data-grade="{{ grade }}" style="{% if grade != 'å…¨éƒ¨' %}display: none;{% else %}display: block;{% endif %}">
        <div class="row" id="cardContainer-{{ grade }}"></div>

        <div class="text-center mt-3">
          <!-- âœ… åŒæ¨£æŠŠ grade å‚³å…¥ -->
          <button class="btn btn-outline-secondary me-2" data-role="prev" data-grade="{{ grade }}" onclick="prevPageAcrossGrades('{{ grade }}')">â¬…ï¸ ä¸Šä¸€é </button>
          <span id="pageInfo-{{ grade }}"></span>
          <button class="btn btn-outline-secondary ms-2" data-role="next" data-grade="{{ grade }}" onclick="nextPageAcrossGrades('{{ grade }}')">â¡ï¸ ä¸‹ä¸€é </button>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- JS å€ -->
<script>
  const IS_CLOSED      = {{ 'true' if is_closed else 'false' }};
  const REFRESH_MS     = {{ refresh_interval * 1000 if not is_closed else 10000 }};  // ç¥¨æ•¸åˆ·æ–°
  const SLIDE_MS       = {{ slide_interval * 1000 if not is_closed else 5000 }};     // è¼ªæ’­
  const CARDS_PER_PAGE = 30;

  const GRADE_ORDER = ['å¹¼å…’åœ’', 'ä¸€å¹´ç´š', 'äºŒå¹´ç´š', 'ä¸‰å¹´ç´š', 'å››å¹´ç´š', 'äº”å¹´ç´š', 'å…­å¹´ç´š'];
  const rawGrouped = {{ grouped_candidates_serializable|tojson }};
  const candidatesByGrade = {};

  for (const [g, arr] of Object.entries(rawGrouped)) {
    candidatesByGrade[g] = arr.slice();
  }
  if (!candidatesByGrade['å…¨éƒ¨']) {
    let all = [];
    GRADE_ORDER.forEach(order => {
      if (candidatesByGrade[order]) all = all.concat(candidatesByGrade[order]);
    });
    Object.keys(candidatesByGrade).forEach(g => {
      if (g !== 'å…¨éƒ¨' && !GRADE_ORDER.includes(g)) all = all.concat(candidatesByGrade[g]);
    });
    candidatesByGrade['å…¨éƒ¨'] = all;
  }

  const grades = Array.from(document.querySelectorAll('.grade-tab')).map(btn => btn.dataset.grade);
  let currentIndex = 0, paused = false, slideTimer = null;
  const currentPages = {};   // å„ grade ç›®å‰é ç¢¼

  function renderCards(grade) {
    const candidates = candidatesByGrade[grade] || [];
    const page = currentPages[grade] || 1;
    const start = (page - 1) * CARDS_PER_PAGE;
    const end = start + CARDS_PER_PAGE;
    const visible = candidates.slice(start, end);

    const container = document.getElementById(`cardContainer-${grade}`);
    const pageInfo  = document.getElementById(`pageInfo-${grade}`);
    if (!container) return;

    container.innerHTML = '';
    visible.forEach(c => {
      const col = document.createElement('div');
      col.className = 'col-lg-2 col-md-3 col-sm-4 col-6 mb-3';
      col.innerHTML = `
        <div class="card shadow text-center fs-5 p-3 candidate-card" data-id="${c.id}">
          <div><strong>${c.class_display} ${c.parent_name}</strong></div>
          <div class="text-success mt-2 fs-4 vote-count">${c.votes} ç¥¨</div>
        </div>`;
      container.appendChild(col);
    });

    const totalPages = Math.ceil(candidates.length / CARDS_PER_PAGE) || 1;
    if (pageInfo) pageInfo.textContent = `ç¬¬ ${page} é  / å…± ${totalPages} é `;
    currentPages[grade] = Math.min(page, totalPages);

    // âœ… åŒ grade çš„ä¸Šä¸‹é æŒ‰éˆ•å•Ÿç”¨/åœç”¨
    const section = document.querySelector(`.grade-section[data-grade="${grade}"]`);
    if (section) {
      const prevBtn = section.querySelector('button[data-role="prev"]');
      const nextBtn = section.querySelector('button[data-role="next"]');
      if (prevBtn) prevBtn.disabled = (totalPages === 1 || page <= 1);
      if (nextBtn) nextBtn.disabled = (totalPages === 1 || page >= totalPages);
    }
  }

  function showGrade(grade) {
    document.querySelectorAll('.grade-section').forEach(div => {
      div.style.display = div.dataset.grade === grade ? 'block' : 'none';
    });
    document.querySelectorAll('.grade-tab').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.grade === grade);
    });
    document.getElementById('currentGrade').textContent = grade;

    if (!currentPages[grade]) currentPages[grade] = 1;
    renderCards(grade);
  }

  function nextGrade() {
    const currentGrade = grades[currentIndex];
    if (currentGrade === 'å…¨éƒ¨') return;   // ã€Œå…¨éƒ¨ã€ä¸è¼ªæ’­
    currentIndex = (currentIndex + 1) % grades.length;
    if (grades[currentIndex] === 'å…¨éƒ¨') currentIndex = (currentIndex + 1) % grades.length;
    showGrade(grades[currentIndex]);
  }

  function toggleSlide() {
    paused = !paused;
    document.getElementById('toggleSlideBtn').textContent = paused ? 'â–¶ï¸ ç¹¼çºŒè¼ªæ’­' : 'â¸ï¸ æš«åœè¼ªæ’­';
  }

  function startSlide() {
    slideTimer = setInterval(() => {
      if (!paused) nextGrade();
    }, SLIDE_MS);
  }

  // âœ… ä¿®æ­£ï¼šæ”¯æ´ã€Œå…¨éƒ¨ã€ä¹Ÿèƒ½ç¿»é 
  function prevPageAcrossGrades(grade) {
    grade = grade || grades[currentIndex];
    const total = Math.ceil((candidatesByGrade[grade] || []).length / CARDS_PER_PAGE) || 1;

    if ((currentPages[grade] || 1) > 1) {
      currentPages[grade]--;
      renderCards(grade);
      return;
    }

    // ç¬¬ä¸€é å†å¾€å‰ï¼šå¦‚æœæ˜¯ã€Œå…¨éƒ¨ã€å°±åœä½ï¼›å¦å‰‡è·³åˆ°å‰ä¸€å€‹å¹´ç´šæœ€å¾Œä¸€é 
    if (grade === 'å…¨éƒ¨') {
      currentPages[grade] = 1;
      renderCards(grade);
      return;
    }

    do {
      currentIndex = (currentIndex - 1 + grades.length) % grades.length;
    } while (grades[currentIndex] === 'å…¨éƒ¨'); // è·³éå…¨éƒ¨
    const prevGrade = grades[currentIndex];
    const totalPrev = Math.ceil((candidatesByGrade[prevGrade] || []).length / CARDS_PER_PAGE) || 1;
    currentPages[prevGrade] = totalPrev;
    showGrade(prevGrade);
  }

  function nextPageAcrossGrades(grade) {
    grade = grade || grades[currentIndex];
    const total = Math.ceil((candidatesByGrade[grade] || []).length / CARDS_PER_PAGE) || 1;

    if ((currentPages[grade] || 1) < total) {
      currentPages[grade]++;
      renderCards(grade);
      return;
    }

    // æœ€å¾Œä¸€é å†å¾€å¾Œï¼šå¦‚æœæ˜¯ã€Œå…¨éƒ¨ã€å°±åœä½ï¼›å¦å‰‡è·³åˆ°ä¸‹ä¸€å€‹å¹´ç´šç¬¬ä¸€é 
    if (grade === 'å…¨éƒ¨') {
      currentPages[grade] = total;
      renderCards(grade);
      return;
    }

    do {
      currentIndex = (currentIndex + 1) % grades.length;
    } while (grades[currentIndex] === 'å…¨éƒ¨'); // è·³éå…¨éƒ¨
    const nextGrade = grades[currentIndex];
    currentPages[nextGrade] = 1;
    showGrade(nextGrade);
  }

  function updateVotes() {
    fetch('/admin/api/live_votes')
      .then(res => res.json())
      .then(list => {
        const items = Array.isArray(list) ? list : (list.candidates || []);
        items.forEach(item => {
          Object.keys(candidatesByGrade).forEach(g => {
            candidatesByGrade[g].forEach(c => {
              if (c.id === item.id) c.votes = item.vote_count || item.votes || 0;
            });
          });

          const card = document.querySelector(`.candidate-card[data-id='${item.id}']`);
          if (card) {
            const voteEl = card.querySelector('.vote-count');
            if (voteEl) voteEl.textContent = `${item.vote_count || item.votes || 0} ç¥¨`;
          }
        });

        showGrade(grades[currentIndex]);
      });
  }

  function closeVote() {
    if (confirm('ç¢ºå®šè¦é—œé–‰æŠ•ç¥¨ï¼Ÿ')) {
      fetch('/admin/phase/close', { method: 'POST' })
        .then(() => window.location.href = '/admin/winners');
    }
  }

  function toggleFullscreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  }

  document.addEventListener('fullscreenchange', () => {
    const isFullscreen = !!document.fullscreenElement;
    const panel = document.getElementById('controlPanel');
    if (panel) panel.classList.toggle('d-none', isFullscreen);
  });

  document.addEventListener('DOMContentLoaded', () => {
    grades.forEach(g => currentPages[g] = 1);
    currentIndex = grades.indexOf('å…¨éƒ¨') !== -1 ? grades.indexOf('å…¨éƒ¨') : 0;
    showGrade(grades[currentIndex]);

    document.querySelectorAll('.grade-tab').forEach((btn) => {
      btn.addEventListener('click', () => {
        const grade = btn.dataset.grade;
        currentIndex = grades.indexOf(grade);
        showGrade(grade);
      });
    });

    if (!IS_CLOSED) {
      startSlide();
      setInterval(updateVotes, REFRESH_MS);
    }
  });
</script>
{% endblock %}
