{% extends "layout.html" %}
{% block title %}åŒç¥¨è€…æ™‰ç´šè™•ç†{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="text-center mb-4">
    <h2>ğŸ† åŒç¥¨è€…æ™‰ç´šè™•ç†</h2>

    <!-- éšæ®µé¸å–® -->
    <form method="GET" action="{{ url_for('admin_promote.promote_page') }}" class="mb-3">
      <label for="phase_id" class="form-label">ğŸ“Œ è«‹é¸æ“‡éšæ®µï¼š</label>
      <select name="phase_id" id="phase_id" class="form-select w-auto d-inline-block" onchange="this.form.submit()">
        {% for phase in phases %}
          <option value="{{ phase.id }}" {% if phase.id == current_phase.id %}selected{% endif %}>
            {{ phase.name }}
          </option>
        {% endfor %}
      </select>
    </form>

    <!-- æŠ•ç¥¨è³‡è¨Š -->
    <h5>éšæ®µåç¨±ï¼š<strong>{{ current_phase.name }}</strong></h5>
    <p class="text-muted">
      é è¨ˆæ™‰ç´šäººæ•¸ï¼š<strong>{{ promote_count }}</strong>ï¼Œ
      è‡ªå‹•æ™‰ç´šï¼š<strong>{{ auto_promoted|length }}</strong>äººï¼Œ
      åŒç¥¨å¾…é¸ï¼š<strong>{{ tied_candidates|length }}</strong>äººï¼Œ
      å°šéœ€å‹¾é¸ï¼š<strong>{{ remaining_to_promote }}</strong>äºº
    </p>
    <p class="text-success">
      âœ… è³‡æ–™åº«ç›®å‰æ™‰ç´šè€…æ•¸é‡ï¼š<strong>{{ actual_promoted_count }}</strong>
    </p>
    <p class="text-primary" id="selectedCountText">å·²é¸ 0 / {{ remaining_to_promote }} äºº</p>

    <!-- åŠŸèƒ½æŒ‰éˆ• -->
    <a href="{{ url_for('admin_promote.export_vote_results', phase_id=current_phase.id) }}"
       class="btn btn-outline-primary">
      ğŸ“„ åŒ¯å‡ºæŠ•ç¥¨çµæœï¼ˆåƒ…æ­¤éšæ®µï¼‰
    </a>


      <a href="{{ url_for('admin_promote.export_promoted_candidates', phase_id=current_phase.id) }}" class="btn btn-outline-success">
        ğŸ… åŒ¯å‡ºç•¶é¸äººåå–®
      </a>
      <a href="{{ url_for('admin_promote.goto_next_phase', phase_id=current_phase.id) }}"
         class="btn btn-outline-warning">
        â© å‰å¾€ä¸‹ä¸€éšæ®µ
      </a>

      <form method="POST" action="{{ url_for('admin_promote.open_phase', phase_id=current_phase.id) }}" class="d-inline">
        <button type="submit" class="btn btn-success" onclick="return confirm('âœ… ç¢ºå®šè¦é–‹å•Ÿæœ¬éšæ®µæŠ•ç¥¨å—ï¼Ÿ')">
         âœ… é–‹å•Ÿæœ¬éšæ®µæŠ•ç¥¨
        </button>
      </form>
    </div>

    <!-- âœ… æ™‰ç´šç¢ºèªè¡¨å–®ï¼ˆç„¡è«–æœ‰ç„¡åŒç¥¨è€…çš†é ˆé€å‡ºï¼‰ -->
    <form method="POST" action="{{ url_for('admin_promote.save_promoted_candidates') }}" id="promoteForm">
      <input type="hidden" name="phase_id" value="{{ current_phase.id }}">

      {% if tied_candidates %}
      <div class="row">
        {% for item in tied_candidates %}
        <div class="col-md-3 mb-3">
          <label class="w-100">
            <input type="checkbox"
                   name="candidate_ids"
                   value="{{ item[0].id }}"
                   class="form-check-input checkbox-candidate d-none"
                   id="checkbox-{{ item[0].id }}">
            <div class="card card-candidate text-center p-3"
                 style="cursor: pointer; border: 2px solid #ccc; transition: 0.2s;">
              <strong>{{ item[0].class_name }} {{ item[0].parent_name }}</strong>
              <p class="mb-0">ç¥¨æ•¸ï¼š{{ item[1] }}</p>
              {% if item[0].is_promoted %}
                <small class="text-muted">
                  {% if item[0].promote_type == 'auto' %}
                    ï¼ˆè‡ªå‹•æ™‰ç´šï¼‰
                  {% elif item[0].promote_type == 'manual' %}
                    ï¼ˆæ‰‹å‹•å‹¾é¸ï¼‰
                  {% endif %}
                </small>
              {% endif %}
            </div>
          </label>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="alert alert-info text-center">
        ğŸ‰ ç„¡åŒç¥¨å€™é¸äººï¼Œå·²è‡ªå‹•å®Œæˆåˆæ­¥æ™‰ç´šï¼Œè«‹é»æ“Šä¸‹æ–¹ã€Œç¢ºèªæ™‰ç´šã€å„²å­˜è‡³è³‡æ–™åº«ã€‚
      </div>
      {% endif %}

      <div class="alert alert-warning text-center">
        ğŸ“Œ æé†’ï¼š<strong>è«‹å‹™å¿…é»æ“Šã€Œç¢ºèªæ™‰ç´šã€</strong>ï¼Œç³»çµ±æ‰æœƒæ­£å¼å„²å­˜æ™‰ç´šåå–®ï¼Œæ‰èƒ½é€²è¡ŒåŒ¯å‡ºæˆ–å¸¶å…¥ä¸‹ä¸€éšæ®µã€‚
      </div>

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-success">
          âœ… ç¢ºèªæ™‰ç´šï¼ˆå…± {{ promote_count }} äººï¼‰
        </button>
      </div>
    </form>
  </div>
</div>

<!-- âœ… æ¨£å¼ -->
<style>
.card-candidate.selected {
  background-color: #d3e5ff;
  border-color: #0d6efd;
}
</style>

<!-- âœ… JS -->
<script>
function updateSelectedCount() {
  const checked = document.querySelectorAll('.checkbox-candidate:checked').length;
  const required = {{ remaining_to_promote }};
  const countText = document.getElementById("selectedCountText");

  countText.textContent = `å·²é¸ ${checked} / ${required} äºº`;

  if (checked === required) {
    countText.classList.remove('text-danger');
    countText.classList.add('text-success');
  } else {
    countText.classList.remove('text-success');
    countText.classList.add('text-danger');
  }
}

// é»æ“Šå¡ç‰‡åˆ‡æ›å‹¾é¸
document.querySelectorAll('.card-candidate').forEach(card => {
  card.addEventListener('click', function (e) {
    e.preventDefault();
    const checkbox = this.closest('label').querySelector('.checkbox-candidate');
    checkbox.checked = !checkbox.checked;
    checkbox.dispatchEvent(new Event('change'));
  });
});

// å‹¾é¸è®Šè‰²
document.querySelectorAll('.checkbox-candidate').forEach(cb => {
  cb.addEventListener('change', function () {
    const card = this.closest('label').querySelector('.card-candidate');
    card.classList.toggle('selected', this.checked);
    updateSelectedCount();
  });
});

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
window.onload = () => {
  document.querySelectorAll('.checkbox-candidate:checked').forEach(cb => {
    cb.closest('label').querySelector('.card-candidate').classList.add('selected');
  });
  updateSelectedCount();
};

// æäº¤å‰é©—è­‰ï¼ˆåƒ…ç•¶æœ‰åŒç¥¨è€…æ‰é©—è­‰é¸å–äººæ•¸ï¼‰
document.getElementById("promoteForm")?.addEventListener("submit", function (e) {
  const tiedExists = {{ 'true' if tied_candidates else 'false' }};
  const checkedCount = document.querySelectorAll('.checkbox-candidate:checked').length;
  const required = {{ remaining_to_promote }};
  if (tiedExists && checkedCount !== required) {
    alert(`âš ï¸ è«‹å‹¾é¸æ­£ç¢ºäººæ•¸ï¼š${required} äººï¼Œç›®å‰é¸å– ${checkedCount} äºº`);
    e.preventDefault();
  }
});
</script>
{% endblock %}
