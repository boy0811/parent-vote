{% extends "layout.html" %}
{% block title %}簽到面板{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">📲 家長簽到面板</h2>

  <!-- ✅ 顯示當前階段 -->
  {% if current_phase %}
    <div class="alert alert-info text-center fs-5">
      📌 當前階段： <strong>{{ current_phase.name }}</strong>
    </div>
  {% else %}
    <div class="alert alert-warning text-center fs-5">
      ⛔ 尚未開啟任何階段
    </div>
  {% endif %}

  <!-- ✅ 簽到統計 -->
  <div class="alert alert-success text-center fs-5">
    ✅ 已簽到 <strong>{{ signed_count }}</strong> / 總人數 <strong>{{ total }}</strong>
  </div>

  <!-- ✅ 年級折疊群組 -->
  <div class="accordion" id="gradeAccordion">
    {% for grade, users_in_grade in grade_groups.items() %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ loop.index }}">
          <button class="accordion-button collapsed grade-center" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}"
                  aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
            <div class="w-100 text-center">
              {{ grade }}
              <span class="badge bg-primary ms-2">{{ users_in_grade|length }}</span>
            </div>
          </button>
        </h2>
        <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse"
             aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#gradeAccordion">
          <div class="accordion-body">
            <div class="row g-3">
              {% for u in users_in_grade %}
              <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card shadow-sm rounded-4 p-3 text-center {% if u.is_signed_in %}bg-success text-white{% else %}bg-light{% endif %}">
                  <h5 class="fw-bold">{{ u.username }}</h5>

                  {% if u.is_signed_in %}
                    <p class="small">🕒 已簽到：{{ u.signed_in_time.strftime("%H:%M:%S") if u.signed_in_time else "" }}</p>
                    <button class="btn btn-outline-light rounded-pill mt-2" onclick="unSignIn({{ u.id }}, this)">❌ 取消</button>
                  {% else %}
                    <button class="btn btn-outline-success rounded-pill mt-2" onclick="signIn({{ u.id }}, this)">✔️ 簽到</button>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="text-center mt-4">
    <a href="{{ url_for('admin_dashboard.admin_dashboard') }}" class="btn btn-outline-secondary rounded-pill px-4 py-2">← 返回主控台</a>
  </div>
</div>

<script>
function signIn(userId, button) {
  if (!confirm('確定要簽到嗎？')) return;
  button.disabled = true;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 簽到中...';

  fetch(`/checkin_panel/signin/${userId}`, {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const card = button.closest('.card');
        const username = card.querySelector('h5').innerText;
        const now = new Date().toLocaleTimeString('zh-TW', { hour12: false });

        card.classList.remove('bg-light');
        card.classList.add('bg-success', 'text-white');
        card.innerHTML = `
          <h5 class="fw-bold">${username}</h5>
          <p class="small">🕒 已簽到：${now}</p>
          <button class="btn btn-outline-light rounded-pill mt-2" onclick="unSignIn(${userId}, this)">❌ 取消</button>
        `;
      } else {
        alert('簽到失敗');
        button.disabled = false;
        button.innerText = '✔️ 簽到';
      }
    });
}

function unSignIn(userId, button) {
  if (!confirm('確定要取消簽到嗎？')) return;
  button.disabled = true;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 取消中...';

  fetch(`/checkin_panel/uncheckin/${userId}`, {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const card = button.closest('.card');
        const username = card.querySelector('h5').innerText;

        card.classList.remove('bg-success', 'text-white');
        card.classList.add('bg-light');
        card.innerHTML = `
          <h5 class="fw-bold">${username}</h5>
          <button class="btn btn-outline-success rounded-pill mt-2" onclick="signIn(${userId}, this)">✔️ 簽到</button>
        `;
      } else {
        alert('取消失敗');
        button.disabled = false;
        button.innerText = '❌ 取消';
      }
    });
}
</script>

<!-- ✅ 強制讓年級標題文字置中 -->
<style>
.accordion-button.grade-center {
  justify-content: center !important;
  text-align: center !important;
}
.accordion-button.grade-center::after {
  margin-left: auto; /* 保持箭頭靠右 */
}
</style>
{% endblock %}
