{% extends "layout.html" %}
{% block title %}ç°½åˆ°é¢æ¿{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">ğŸ“² å®¶é•·ç°½åˆ°é¢æ¿</h2>

  <!-- âœ… é¡¯ç¤ºç•¶å‰éšæ®µ -->
  {% if selected_phase_id %}
    <div class="alert alert-info text-center fs-5">
      ğŸ“Œ ç•¶å‰éšæ®µï¼š 
      {% for phase in phases %}
        {% if phase.id == selected_phase_id|int %}
          <strong>{{ phase.name }}</strong>
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-warning text-center fs-5">
      â›” å°šæœªé¸æ“‡éšæ®µ
    </div>
  {% endif %}

  <!-- âœ… å¹´ç´šç¯©é¸ -->
  <form method="get" class="d-flex flex-wrap justify-content-center gap-3 mb-4">
    <input type="hidden" name="phase_id" value="{{ selected_phase_id }}">
    <div class="input-group" style="max-width: 250px;">
      <label class="input-group-text">å¹´ç´š</label>
      <select name="grade" class="form-select">
        <option value="">å…¨éƒ¨</option>
        <option value="å¹¼å…’åœ’" {% if selected_grade == 'å¹¼å…’åœ’' %}selected{% endif %}>å¹¼å…’åœ’</option>
        <option value="ä¸€å¹´ç´š" {% if selected_grade == 'ä¸€å¹´ç´š' %}selected{% endif %}>ä¸€å¹´ç´š</option>
        <option value="äºŒå¹´ç´š" {% if selected_grade == 'äºŒå¹´ç´š' %}selected{% endif %}>äºŒå¹´ç´š</option>
        <option value="ä¸‰å¹´ç´š" {% if selected_grade == 'ä¸‰å¹´ç´š' %}selected{% endif %}>ä¸‰å¹´ç´š</option>
        <option value="å››å¹´ç´š" {% if selected_grade == 'å››å¹´ç´š' %}selected{% endif %}>å››å¹´ç´š</option>
        <option value="äº”å¹´ç´š" {% if selected_grade == 'äº”å¹´ç´š' %}selected{% endif %}>äº”å¹´ç´š</option>
        <option value="å…­å¹´ç´š" {% if selected_grade == 'å…­å¹´ç´š' %}selected{% endif %}>å…­å¹´ç´š</option>
      </select>
    </div>
    <button type="submit" class="btn btn-outline-primary">æŸ¥è©¢</button>
  </form>

  <div class="row g-3">
    {% for c in candidates %}
    <div class="col-lg-3 col-md-4 col-sm-6">
      <div class="card shadow-sm rounded-4 p-3 text-center {% if c.is_signed_in %}bg-success text-white{% else %}bg-light{% endif %}">
        <h5 class="fw-bold">{{ c.class_name }}</h5>
        <p>{{ c.parent_name }}</p>

        {% if c.phase_id in [2,3] %}
          {% if not c.is_signed_in %}
            <button class="btn btn-outline-success rounded-pill mt-2" onclick="signIn({{ c.id }}, this)">âœ”ï¸ ç°½åˆ°</button>
          {% else %}
            <button class="btn btn-outline-light rounded-pill mt-2" onclick="unSignIn({{ c.id }}, this)">âŒ å–æ¶ˆ</button>
          {% endif %}
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="text-center mt-4">
    <a href="{{ url_for('admin_dashboard.admin_dashboard') }}" class="btn btn-outline-secondary rounded-pill px-4 py-2">â† è¿”å›ä¸»æ§å°</a>
  </div>
</div>

<script>
function signIn(candidateId, button) {
  if (!confirm('ç¢ºå®šè¦ç°½åˆ°å—ï¼Ÿ')) return;
  button.disabled = true;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ç°½åˆ°ä¸­...';

  fetch(`/checkin_panel/signin/${candidateId}`, {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const card = button.closest('.card');
        const className = card.querySelector('h5').innerText;
        const parentName = card.querySelector('p').innerText;

        card.classList.remove('bg-light');
        card.classList.add('bg-success', 'text-white');
        card.innerHTML = `
          <h5 class="fw-bold">${className}</h5>
          <p>${parentName}</p>
          <button class="btn btn-outline-light rounded-pill mt-2" onclick="unSignIn(${candidateId}, this)">âŒ å–æ¶ˆ</button>
        `;
      } else {
        alert('ç°½åˆ°å¤±æ•—');
        button.disabled = false;
        button.innerText = 'âœ”ï¸ ç°½åˆ°';
      }
    });
}

function unSignIn(candidateId, button) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆç°½åˆ°å—ï¼Ÿ')) return;
  button.disabled = true;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> å–æ¶ˆä¸­...';

  fetch(`/checkin_panel/uncheckin/${candidateId}`, {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const card = button.closest('.card');
        const className = card.querySelector('h5').innerText;
        const parentName = card.querySelector('p').innerText;

        card.classList.remove('bg-success', 'text-white');
        card.classList.add('bg-light');
        card.innerHTML = `
          <h5 class="fw-bold">${className}</h5>
          <p>${parentName}</p>
          <button class="btn btn-outline-success rounded-pill mt-2" onclick="signIn(${candidateId}, this)">âœ”ï¸ ç°½åˆ°</button>
        `;
      } else {
        alert('å–æ¶ˆå¤±æ•—');
        button.disabled = false;
        button.innerText = 'âŒ å–æ¶ˆ';
      }
    });
}
</script>
{% endblock %}
