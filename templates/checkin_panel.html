{% extends "layout.html" %}
{% block title %}ç°½åˆ°é¢æ¿{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="text-center mb-4">ğŸ“² å®¶é•·ç°½åˆ°é¢æ¿</h2>

  <!-- âœ… é¡¯ç¤ºç•¶å‰éšæ®µ -->
  {% if current_phase %}
    <div class="alert alert-info text-center fs-5">
      ğŸ“Œ ç•¶å‰éšæ®µï¼š <strong>{{ current_phase.name }}</strong>
    </div>
  {% else %}
    <div class="alert alert-warning text-center fs-5">
      â›” å°šæœªé–‹å•Ÿä»»ä½•éšæ®µ
    </div>
  {% endif %}

  <!-- âœ… ç°½åˆ°çµ±è¨ˆ -->
  <div class="alert alert-success text-center fs-5">
    âœ… å·²ç°½åˆ° <strong>{{ signed_count }}</strong> / ç¸½äººæ•¸ <strong>{{ total }}</strong>
  </div>

  <!-- âœ… å¹´ç´šæŠ˜ç–Šç¾¤çµ„ -->
  <div class="accordion" id="gradeAccordion">
    {% for grade, users_in_grade in grade_groups.items() %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading-{{ loop.index }}">
          <button class="accordion-button collapsed grade-center" type="button"
                  data-bs-toggle="collapse" data-bs-target="#collapse-{{ loop.index }}"
                  aria-expanded="false" aria-controls="collapse-{{ loop.index }}">
            <div class="w-100 text-center">
              {{ grade }}
              <span class="badge bg-primary ms-2">{{ users_in_grade|length }}</span>
            </div>
          </button>
        </h2>
        <div id="collapse-{{ loop.index }}" class="accordion-collapse collapse"
             aria-labelledby="heading-{{ loop.index }}" data-bs-parent="#gradeAccordion">
          <div class="accordion-body">
            <div class="row g-3">
              {% for u in users_in_grade %}
              <div class="col-lg-3 col-md-4 col-sm-6">
                <div class="card shadow-sm rounded-4 p-3 text-center {% if u.is_signed_in %}bg-success text-white{% else %}bg-light{% endif %}">
                  <h5 class="fw-bold">{{ u.username }}</h5>

                  {% if u.is_signed_in %}
                    <p class="small">ğŸ•’ å·²ç°½åˆ°ï¼š{{ u.signed_in_time.strftime("%H:%M:%S") if u.signed_in_time else "" }}</p>
                    <button class="btn btn-outline-light rounded-pill mt-2" onclick="unSignIn({{ u.id }}, this)">âŒ å–æ¶ˆ</button>
                  {% else %}
                    <button class="btn btn-outline-success rounded-pill mt-2" onclick="signIn({{ u.id }}, this)">âœ”ï¸ ç°½åˆ°</button>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <div class="text-center mt-4">
    <a href="{{ url_for('admin_dashboard.admin_dashboard') }}" class="btn btn-outline-secondary rounded-pill px-4 py-2">â† è¿”å›ä¸»æ§å°</a>
  </div>
</div>

<script>
function signIn(userId, button) {
  if (!confirm('ç¢ºå®šè¦ç°½åˆ°å—ï¼Ÿ')) return;
  button.disabled = true;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ç°½åˆ°ä¸­...';

  fetch(`/checkin_panel/signin/${userId}`, {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const card = button.closest('.card');
        const username = card.querySelector('h5').innerText;
        const now = new Date().toLocaleTimeString('zh-TW', { hour12: false });

        card.classList.remove('bg-light');
        card.classList.add('bg-success', 'text-white');
        card.innerHTML = `
          <h5 class="fw-bold">${username}</h5>
          <p class="small">ğŸ•’ å·²ç°½åˆ°ï¼š${now}</p>
          <button class="btn btn-outline-light rounded-pill mt-2" onclick="unSignIn(${userId}, this)">âŒ å–æ¶ˆ</button>
        `;
      } else {
        alert('ç°½åˆ°å¤±æ•—');
        button.disabled = false;
        button.innerText = 'âœ”ï¸ ç°½åˆ°';
      }
    });
}

function unSignIn(userId, button) {
  if (!confirm('ç¢ºå®šè¦å–æ¶ˆç°½åˆ°å—ï¼Ÿ')) return;
  button.disabled = true;
  button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> å–æ¶ˆä¸­...';

  fetch(`/checkin_panel/uncheckin/${userId}`, {method: 'POST'})
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const card = button.closest('.card');
        const username = card.querySelector('h5').innerText;

        card.classList.remove('bg-success', 'text-white');
        card.classList.add('bg-light');
        card.innerHTML = `
          <h5 class="fw-bold">${username}</h5>
          <button class="btn btn-outline-success rounded-pill mt-2" onclick="signIn(${userId}, this)">âœ”ï¸ ç°½åˆ°</button>
        `;
      } else {
        alert('å–æ¶ˆå¤±æ•—');
        button.disabled = false;
        button.innerText = 'âŒ å–æ¶ˆ';
      }
    });
}
</script>

<!-- âœ… å¼·åˆ¶è®“å¹´ç´šæ¨™é¡Œæ–‡å­—ç½®ä¸­ -->
<style>
.accordion-button.grade-center {
  justify-content: center !important;
  text-align: center !important;
}
.accordion-button.grade-center::after {
  margin-left: auto; /* ä¿æŒç®­é ­é å³ */
}
</style>
{% endblock %}
