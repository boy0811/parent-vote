{% extends "layout.html" %}
{% block title %}{{ vote_title }}{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="card shadow rounded-4 mb-4">
    <div class="card-body text-center">
      <h2 class="card-title mb-3">{{ vote_title }}</h2>
      <h5 class="text-center mb-3">
        ğŸ“Œ ç•¶å‰éšæ®µï¼š
        {% if phase %}
          <strong>{{ phase.name }}</strong>ï¼ˆæœ€å¤š <strong>{{ max_votes }}</strong> ç¥¨ï¼‰
        {% else %}
          <span class="text-muted">å°šæœªé–‹å•Ÿä»»ä½•æŠ•ç¥¨éšæ®µ</span>
        {% endif %}
      </h5>
      <div class="text-muted fs-6">
        âœ… å·²é¸ï¼š<strong id="selectedCount">0</strong> / {{ max_votes }}
      </div>
      {% if phase %}
      <p class="text-muted mt-2">
        è«‹é¸æ“‡ <strong>1</strong> ~ <strong>{{ max_votes }}</strong> ä½å€™é¸äººã€‚
      </p>
      {% endif %}
    </div>
  </div>

  {% if phase %}
  <form method="POST" action="{{ url_for('auth.vote') }}" onsubmit="return validateVote()">
    <input type="hidden" name="phase_id" value="{{ phase.id }}">

    <div class="accordion" id="gradeAccordion">
      {% for grade in ['å¹¼å…’åœ’', 'ä¸€å¹´ç´š', 'äºŒå¹´ç´š', 'ä¸‰å¹´ç´š', 'å››å¹´ç´š', 'äº”å¹´ç´š', 'å…­å¹´ç´š'] %}
        {% set candidates = grouped_candidates.get(grade, []) %}
        {% set bg_class = 'bg-warning-subtle' if loop.index is even else '' %}
        <div class="accordion-item rounded-4 overflow-hidden {{ bg_class }}">
          <h2 class="accordion-header">
            <button class="accordion-button {% if loop.first %}show{% else %}collapsed{% endif %} {{ bg_class }} fw-bold text-center" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="{% if loop.first %}true{% else %}false{% endif %}" aria-controls="collapse{{ loop.index }}">
              <div class="w-100 text-center">{{ grade }}ï¼ˆ{{ candidates|length }}äººï¼‰</div>
            </button>
          </h2>
          <div id="collapse{{ loop.index }}" class="accordion-collapse collapse {% if loop.first %}show{% endif %}">
            <div class="accordion-body text-center">
              {% if candidates %}
                <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                  {% for candidate in candidates %}
                    <div class="col">
                      <div class="candidate-item border p-4 rounded-4 shadow-sm h-100 d-flex align-items-center justify-content-center flex-column">
                        <input type="checkbox" class="vote-checkbox" name="candidate_ids" value="{{ candidate.id }}" id="cand{{ candidate.id }}">
                        <label for="cand{{ candidate.id }}" class="w-100 mb-2 fw-bold fs-5" style="cursor:pointer;">{{ candidate.class_name }} {{ candidate.parent_name }}</label>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-muted">æ­¤å¹´ç´šæš«ç„¡å€™é¸äºº</p>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="mt-4 text-center">
      <button type="submit" class="btn btn-success rounded-pill px-5 py-2 shadow">ğŸ—³ï¸ ç¢ºèªæŠ•ç¥¨</button>
    </div>
  </form>
  {% else %}
    <div class="alert alert-warning text-center">âš ï¸ å°šæœªé–‹å•Ÿä»»ä½•æŠ•ç¥¨éšæ®µï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>
  {% endif %}
</div>

<style>
  .candidate-item {
    cursor: default; /* äº¤çµ¦ label æŒ‡å®š pointer */
    transition: background-color 0.2s, color 0.2s;
    min-height: 100px;
  }
  .candidate-item input[type="checkbox"] {
    display: none;
  }
  .candidate-item input[type="checkbox"]:checked + label {
    background-color: #1f2a38;
    color: #fff;
    display: block;
    padding: 1rem;
    border-radius: 1rem;
  }
</style>

<script>
  const maxVotes = {{ max_votes }};

  document.addEventListener('DOMContentLoaded', () => {
    // ç¶å®šæ¯å€‹ checkbox çš„ change äº‹ä»¶
    document.querySelectorAll('.vote-checkbox').forEach(cb => {
      cb.addEventListener('change', () => onCheckboxChange(cb));
    });
    updateSelectedCount();
  });

  function onCheckboxChange(checkbox) {
    const checkedBoxes = document.querySelectorAll('.vote-checkbox:checked');
    if (checkedBoxes.length > maxVotes) {
      checkbox.checked = false;  // å–æ¶ˆæœ€æ–°å‹¾é¸
      alert(`æœ€å¤šåªèƒ½æŠ• ${maxVotes} äºº`);
      return;
    }
    updateSelectedCount();
  }

  function updateSelectedCount() {
    const checkedBoxes = document.querySelectorAll('.vote-checkbox:checked');
    document.getElementById('selectedCount').innerText = checkedBoxes.length;
  }

  function validateVote() {
    const checkedBoxes = document.querySelectorAll('.vote-checkbox:checked');
    if (checkedBoxes.length === 0) {
      alert("âš ï¸ è«‹è‡³å°‘é¸æ“‡ 1 ä½å€™é¸äºº");
      return false;
    }
    return true; // âœ… å…è¨± 1 ~ maxVotes
  }
</script>
{% endblock %}
